# Hardened SSH Configuration for Debian 12 Bookworm
# Managed by Ansible - DO NOT EDIT MANUALLY

# Specify SSH protocol version to use
# Only allow SSH protocol 2 for improved security
Protocol 2

# Specify the port SSH should listen on
# Use a variable with a default of 22 if not specified
Port {{ ssh_port | default(22) }}

# Disable root login to prevent direct attacks on the root account
PermitRootLogin no

# Disable password authentication to enforce key-based authentication
PasswordAuthentication no

# Enable public key authentication for secure access
PubkeyAuthentication yes

# Restrict SSH access to specific users
# Use a variable with a default of 'monitor' if not specified
AllowUsers {{ ssh_allow_users | default('monitor') }}

# Disable X11 forwarding to prevent potential security risks
X11Forwarding no

# Limit the number of authentication attempts to prevent brute force attacks
# while accommodating clients with multiple SSH keys
MaxAuthTries {{ ssh_max_auth_tries | default(8) }}

# Additional recommended security settings

# Disable empty passwords
PermitEmptyPasswords no

# Set a timeout interval for idle sessions
ClientAliveInterval 300
ClientAliveCountMax 2

# Disable agent forwarding to prevent potential security risks
AllowAgentForwarding no

# Disable TCP forwarding to prevent potential security risks
AllowTcpForwarding no

# Specify which addresses sshd should listen on
ListenAddress 0.0.0.0

# Specify the location of the server's private key
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

# Specify strong ciphers
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Specify strong MACs
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com

# Specify strong key exchange algorithms
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Enable strict mode for improved security
StrictModes yes

# Compress communications to improve performance
Compression delayed

# Log SSH key fingerprints
LogLevel VERBOSE

# Prevent users from setting environment variables
PermitUserEnvironment no

# Use privilege separation for improved security
UsePrivilegeSeparation sandbox
